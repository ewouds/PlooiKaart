name: Deploy Backend to Azure Container App

on:
    push:
        branches:
            - main
        paths:
            - "server/**"
            - "package.json"
            - "Dockerfile"
            - ".github/workflows/deploy-backend.yml"
    workflow_dispatch:

env:
    ACR_NAME: "ewsacr1747"
    CONTAINER_APP_NAME: "plooikaart-backend"
    RESOURCE_GROUP: "rg-plooikaart"
    IMAGE_NAME: "plooikaart-backend"

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Log in to Azure
              uses: azure/login@v2
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Log in to Azure Container Registry
              run: |
                  az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
          file: ./Dockerfile            - name: Configure Container App Registry Access
              # This step ensures the Container App has the credentials to pull from the ACR
              run: |
                  az containerapp registry set \
                    --name ${{ env.CONTAINER_APP_NAME }} \
                    --resource-group ${{ env.RESOURCE_GROUP }} \
                    --server ${{ env.ACR_NAME }}.azurecr.io \
                    --username ${{ env.ACR_NAME }} \
                    --password $(az acr credential show --name ${{ env.ACR_NAME }} --query passwords[0].value -o tsv)

            - name: Deploy to Azure Container App
              uses: azure/container-apps-deploy-action@v1
              with:
                  containerAppName: ${{ env.CONTAINER_APP_NAME }}
                  resourceGroup: ${{ env.RESOURCE_GROUP }}
                  imageToDeploy: ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
                  targetPort: 3000
                  # Note: Environment variables are managed manually in the Azure Portal as requested.
